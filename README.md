# tengen-tetris
Tengen Tetris web app using Python Flask at the backend and p5.js at the frontend

## Introduction
This project runs as a Flask server that users can interact with through their browser, by knowing the IP of the machine that is serving it, and
the port, which by default is 8080 (there is currently no easy way to modify this). It is displayed on the client side using the p5.js library.

It tries to mimic the NES Tetris experience in terms of fall speed and score assignments. The display of elements in the canvas is also
similar to NES Tetris. The duo game mode mechanics have been completely inspired by Tengen Tetris. Finally, the aesthetic has been moved to a more retro-cyberpunk vibe, as if you were playing on some old green phosphorous screen
while the world is falling apart due to the cyborg awakening.

There is a scoreboard to which players can upload their high scores and compete.

![Screenshot of duo mode](https://github.com/aitorperezzz/tengen-tetris/blob/master/images/tengen_readme.png)

## Game modes
There are two game modes:
* Solo: select a level and start playing. You will be on your own. You can pause and quit.
You will be able to submit your high score to the server once you die.
* Duo: click on *Look for another player* and once another user does the same on their client, you will both start a duo game.
Select level at the beginning (ech of you can select its own level) and play. You will be able to see your oponent's screen on the right of yours to track
their movements. The same pieces will fall for both of you, even if you die and decide to try again.

## How to run it on your machine

### OPTION 1 (Docker)

This step requires Docker to be installed as a pre requirement in your machine. After confirming we have Docker installed, we execute the following commands:

``` sh
# Clone this repository locally
git clone https://github.com/joseamoroso/tengen-tetris-ws-challenge

cd tengen-tetris-ws-challenge

# Build the docker image
docker build -t tengen-tetris-ws-challenge-local .

# Run the application in a container with Docker 
docker run -p 8080:8080 jamorosoa/tengen-tetris-ws-challenge-local

```

Now use your browser and navigate to `localhost:8080`, and start playing ðŸ˜€

For __duo mode__ you will need find your local IP address by running `ip a`, and, from another computer within the same network, connect to `<ip>:8080`.

### OPTION 2 (Kubernetes and Helm)

* __Pre-requirements__:

* Enable HPA: Requires [metrics-server](https://github.com/kubernetes-sigs/metrics-server/tree/master/charts/metrics-server).
* Enable Ingress: Requires [aws-load-balancer-controller](https://github.com/kubernetes-sigs/aws-load-balancer-controller/tree/main/helm/aws-load-balancer-controller) and a record set where the subdomain used as hostname, must be pointing to the alb genarated by the ingress.
* Enable Volume (NFS): Requires [efs-csi-driver](https://github.com/kubernetes-sigs/aws-efs-csi-driver/tree/master/charts/aws-efs-csi-driver) and an EFS volume with the the right networks and permission settings to be used within the cluster.

!!! Important !!!

Previuos pre-requirements can be installed and setup by deploying the infrastructure with [tengen-tetris-ws-challenge-infra](https://github.com/joseamoroso/tengen-tetris-ws-challenge-infra) with the expection of the DNS record pointing to the ALB.

This method assumes you have a Kubernetes cluster already deployed (preferable in AWS) to run the application. Also, we'll manage the kubernetes resources with Helm, then you'll need to install kubectl and Helm in your machine to manage the Helm charts.

Once you are authenticated in the kubernetes cluster, follow the next steps:

Clone this repository locally

``` sh
git clone https://github.com/joseamoroso/tengen-tetris-ws-challenge
cd tengen-tetris-ws-challenge
```

Install the Helm chart with the values defined in [values.yaml](./charts/wschallenge/values.yaml).

Remember to replace custom values like `ingress.hosts[0].host` and `volume.server`. These are unique according to each account and user. To use the ingress, you must create a record set pointing your subdomain to the ALB generated by the ingress

``` sh
helm install tengen-tetris charts/wschallenge
```

If you need to update a value after the chart was installed, e.g., `volume.server`, update the values in `values.yaml` file and run:

``` sh
helm upgrade tengen-tetris charts/wschallenge
```

If an application change is needed, update your source code and push the changes to Github (we assume pushs are made in the main branch for this example). The pipeline will do the rest, you only need to refer to the right tag after the image is published. For this we can use git tags, e.g. after a change was submitted to the main branch run:

```sh
git tag v1.0.0 
git push origin v1.0.0
```

Which generate the new image tag: `jamorosoa/tengen-tetris-ws-challenge-gh:v1.0.0`. Now we can update the tag in the [values.yaml](./charts/wschallenge/values.yaml) and run the `helm upgrade tengen-tetris charts/wschallenge` command again. This will generate a new release of the helm chart.

Because we are using deployments, by default they enable rolling out strategy to keep the application up while a new version is deployed, then it has a minimal impact on application usage experience.

To uninstall the Helm chart, we run:

```sh
helm uninstall tengen-tetris
```

### OPTION 3 (Python CLI)

Instructions can only be provided for a Linux box, sorry. Also, specific instructions are given for an Ubuntu Server, although you will be able to figure out
how to install it on any other Linux box.

1. `cd` to a new directory
2. Clone this repo with `git clone`
3. This runs on Python 3, so be sure to have that installed
4. Be sure to have `pip3` package for Python 3 dependencies installation, on Ubuntu this can be installed by running `apt install python3-pip`.
With it, install the following dependencies:
  * `pip3 install flask`
  * `pip3 install flask_socketio`
  * `pip3 install gevent-websockets`


5. Run the server with `python3 application.py` or run it on the background with `nohup python3 application.py > out.log &`
6. Open a web browser and connect to `localhost:8080`. If you can see a page, everything has worked fine.
7. Find out the IP address of your box by running `ip a`, and, from another computer within the same network, connect to `<ip>:8080`.
